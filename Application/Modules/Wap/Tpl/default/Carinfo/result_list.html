<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>订单列表</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="__PUBLIC__/wap/js/flexible.js"></script>
    <link href="__PUBLIC__/wap/css/icons.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/wap/css/base.css" />
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/wap/css/order.css" />

</head>
<body class="order">
<div class="head">
    <a href="javascript:history.go(-1);" class="md-close back"><i class="iconfont">&#xe617</i></a>
    <h2 >查询结果</h2>
</div>

<div class="page">
    <ul class="more_html">
        <volist name="list" id="vo">
            <li>
                <div class="cartlist">

                    <div class="user">
                        <i class="iconfont">&#xe621</i>
                        <a href="{:U('Wap/carinfo/car_detail',array('id'=>$vo['id']))}"><div class="info">
                            <dl>
                                <dt>品牌：</dt>
                                <dd>{$vo.brand}</dd>
                            </dl>
                            <dl>
                                <dt>车系：</dt>
                                <dd>{$vo.series}</dd>
                            </dl>
                            <dl>
                                <dt>车型：</dt>
                                <dd class="num">{$vo.version}</dd>
                            </dl>
                        </div></a>
                    </div>
                </div>
            </li>
        </volist>
    </ul>
    <div style="text-align: center">{$msg}</div>
<div class="loading">
    <div class="fm-footer-copyright get_more">
        <if condition="$count gt 10 && count($list) eq 10">
            加载更多
            <else/>
            无更多数据
        </if>
    </div>
</div>
</div>



<div style="height:50px;">
</div>

<include file="Public/footer_new" />
<script type="text/javascript" src="__PUBLIC__/wap/js/jquery.min.js"></script>
<script src="__PUBLIC__/bootstrap/vendor/jquery-validation/jquery.validate.wap.js"></script>
<script src="__PUBLIC__/js/jquery.form.js"></script>
<script type="text/javascript" src="__PUBLIC__/layer/layer.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/return-top.js"></script>

<input type="hidden" name="p" value="2" />
<input type="hidden" name="order_state" value="{$_GET['order_state']}" />
<input type="hidden" name="order" value=""/>

<script type="text/javascript">
    var load_more = 0;
    var load_none = 0;
    $(function () {
        $(window).scroll(function () {
            var scrollTop = $(this).scrollTop();
            var scrollHeight = $(document).height();
            var windowHeight = $(this).height();
            if (scrollTop + windowHeight == scrollHeight) {
                //此处是滚动条到底部时候触发的事件，在这里写要加载的数据，或者是拉动滚动条的操作
                if (load_none != 1) {
                    if (load_more == 1) {
                        var html = ' <img src="__PUBLIC__/wap/img/icon_zhuan.gif" style="max-width:15px;">'
                        $('.get_more').html('加载中' + html);
                    } else {
                        get_more();
                    }
                }

            }
        });
    })
    $(function(){
        $(".get_more").click(function(){
            get_more();
        });
        $(window).load(function () {
            get_more();
        });
    });
    function get_more(){
        load_more = 1;
        var html = ' <img src="__PUBLIC__/wap/img/icon_zhuan.gif" style="max-width:15px;">';
        $('.get_more').html('加载中' + html);
        var p=$("input[name='p']").val();
        var order_sta=$("input[name='order_state']").val();
        $.ajax({
            url: "{:U('wap/goodsorder/index')}",
            type:'post',
            data: {p:p,order_state:order_sta},
            dataType: 'json',
            success: function(data){
                //console.log(data);
                var con=1;
                var option='';
                if(data){
                    $.each(data, function(i, value) {

                        //this指向当前元素
                        //i表示Array当前下标
                        //value表示Array当前元素
                        var order_state="";
                        if(value.order_state=="nopay"){
                            var pay_url = "<?php echo U('wap/goodsorder/order_pay'); ?>?pay_sn="+value.order_id;
                            if(value.is_upgrade == 1){
                                pay_url = "<?php echo U('wap/start/upgrade_pay'); ?>?order_id="+value.order_id;
                            }
                            order_state='<div class="order-button "><a  class="btn1 btnsF34" href="'+pay_url+'" >去付款</a>'
                                    +' <a class="g-tui delete_order btn3 btnsF34" data-type="1" data="'+value.order_id+'" href="javascript:void(0)">取消订单</a></div>';
                        }else if(value.order_state=="delivered"){
                            var str_delivered="";
                            str_delivered= '<a class="btn1 btnsF34" href="__URL__/order_express?order_id='+value.order_id+'">查看物流</a>'
                                    +' <a class="delivered_order btn2 btnsF34" data="'+value.order_id+'" href="javascript:void(0)">确认收货</a>';
                            order_state='<div class="order-button">'+str_delivered+'</div>';
                        }else if(value.order_state=="after_sale"){
                            str_delivered='' ;
                            order_state='<div class="order-button">'+str_delivered+'</div>';
                        }else if(value.order_state=="received"){
                            order_state='<div class="order-button"><a class="g-tui delete_order btn3 btnsF34" data-type="0" data="'+value.order_id+'" href="javascript:void(0)">删除</a></div>';
                        }else if(value.order_state=="finish"){
                            order_state='<div class="order-button "><a class="g-tui delete_order btn3 btnsF34" data-type="0" data="'+value.order_id+'" href="javascript:void(0)">删除</a></div>';
                        }else{
                            // order_state=value.order_state_name;
                            order_state = '<i class="iconfont floatLft">&#xe68c</i><span>'+ value.status_remarks+'</span>';
                        }
                        var li_order_state = '<li class="typetotal">' + order_state+'</li>';
                        if((value.order_status == 0 && value.pay_status == 2) || value.order_status == 5 ){
                            li_order_state = '';
                        }
                        var goods_list = "";
                        var goods=value.goods;
                        if(goods && value.is_upgrade == 0){
                            $.each(goods, function (n, vo) {

                                var after='';
                                if(vo.after_sale == 1){
                                    after = '<a class="after_sales service type'+vo.refund_status+' "  href="<?php echo U('wap/goodsrefund/index');?>?id='+vo.rec_id+'">'+vo.refund_status_name+'</a>';
                                }

                                var _shipping_money = '包邮';
                                if(vo.shipping_money > 0){
                                    _shipping_money = '运费:￥'+vo.shipping_money;
                                }
                                goods_list =goods_list+ ''
                                        +'<li  class="goods"> '
                                        + '<a class="" href="<?php echo U('wap/goodsorder/order_detail');?>?id='+value.order_id+'">'
                                +'<div class="goodsimg imgnobg">'
                                +'<div class="img bgcover " style=" background:url('+vo.goods_image+')">'
                                +'</div>'
                                +'</div>'
                                +'<div class="info">'
                                +'<div class="title">'
                                +vo.goods_name
                                +' </div>'
                                +' <div class="pay">'
                                +'<div class="pirce num green">'
                                +'￥'+vo.goods_price
                                +'</div>'
                                +'<div class="qty">'
                                +'<span class="num">'+vo.goods_number+'</span>件&nbsp; &nbsp;'+_shipping_money
                                +after
                                +'</div>'
                                +'</div>'
                                +'</div>'
                                +'</a>'
                                +'<div class="clearfix">'
                                +'</div>'
                                +'</li>';

                            });
                        }
                        option=option+'<li>'
                                +'<div class="cartlist">'
                                +'<div class="store">'
                                +value.store_name+'的店铺<span class="state">'+value.order_state_name+'</span>'
                                +'</div>'
                                +'<div class="user">'
                                +'<i class="iconfont">&#xe621</i>'
                                +'<a href="<?php echo  U('Wap/goodsorder/order_detail');?>?id='+value.order_id+'"><div class="info">'
                        +'<dl>'
                        +'<dt>订单号：</dt>'
                        +'<dd class="num">'+value.order_sn+'</dd>'
                        +'</dl>'
                        +'<dl>'
                        +'<dt>收件人：</dt>'
                        +'<dd>'+value.consignee+'</dd>'
                        +'</dl>'
                        +'<dl>'
                        +'<dt>地址：</dt>'
                        +'<dd>'+value.address+'</dd>'
                        +'</dl>'
                        +'<dl>'
                        +'<dt>手机号：</dt>'
                        +'<dd class="num">'+value.mobile+'</dd>'
                        +'</dl>'
                        +'</div></a>'
                        +'</div>'
                        +'<ul>'+goods_list+'</ul><div class="total"><ul>'
                        +'<li class="subtotal">共<span class="num black"> '+value.num+' </span>件商品 合计：<span class=" num green">¥'+value.order_amount+'</span></li>'
                        +li_order_state
                        +'</ul></li>';
                        con++;
                    });
                }
                if(p==1){
                    $('.more_html').html(option);
                }else{
                    $('.more_html').append(option);
                }
                load_more = 0;
                if (option) {
                    $("input[name='p']").val(parseInt(p) + 1);
                }
                if(con<10){
                    load_none = 1;
                    $('.get_more').html('无更多数据');
                    $('.get_more').fadeOut('3000');
                }
            }
        });
    }

</script>
</body>
</html>