<script src="__PUBLIC__/wap/js/flexible.js"></script>
<script type="text/javascript" src="__PUBLIC__/wap/js/jquery.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.form.js"></script>
<script src="__PUBLIC__/bootstrap/vendor/jquery-validation/jquery.validate.wap.js"></script>
<script type="text/javascript" src="__PUBLIC__/layer/layer.js"></script>
<link href="__PUBLIC__/wap/css/icons.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="__PUBLIC__/wap/css/base.css" />
<link rel="stylesheet" type="text/css" href="__PUBLIC__/wap/css/member.css" />
<div class="shares_binding_wx" style=" height:100%; background:#f1ffcd ;">
	<div class="new head">
		<a href="javascript:history.go(-1)" class="md-close back">
			<i class="iconfont">&#xe617</i>
		</a>
		<h2>完善资料</h2>
	</div>

	<div class="bggreen">
		<form id="binding_form"  role="form" class="mlogin newbox" action="" novalidate method="post" onSubmit="return false;">
            <div class="field">
                <div class="label"> 姓名 </div>
                <div class="field-control">
                    <input class="input-required" type="tel" name="real_name" id="real_name" placeholder="请输入用户姓名" value="{$member_info.real_name}" maxlength="11">
                </div>
            </div>
			<div class="field">
				<div class="label"> 手机号 </div>
				<div class="field-control">
					<input class="input-required" type="tel" name="binding_mobile" id="binding_mobile" placeholder="请输入手机号码" value="{$member_info.mobile}" maxlength="11">
				</div>
			</div>
			<div class="field">
				<div class="label"> 验证码 </div>
				<div class="field-control">
					<input class="input-required codeinput" type="text" name="binding_mobile_code" id="binding_mobile_code" placeholder="请输入验证码" maxlength="6">
				</div>
				<a href="javascript:void(0);" class=" code again_message  binding_send_sms">
					发送验证码 <span style="display: none" class="binding_countdown">（<em class="binding_num">60</em>S）</span>
				</a>
			</div>
			<input type="hidden" name="is_binding" id="is_binding" value="0">
			<div class="submit mgt4" style="position:static">
				<button type="button" href="javascript: void(0);" class="button phone_binding_btn">完善资料</button>
			</div>
		</form>
	</div>
</div>
<script type="text/javascript">

    $('.verify_refresh').click(function(){
        //重载验证码
        var time = new Date().getTime();
        var src='{:U('Wap/Login/verify')}?'+time;
        $(this).attr('src',src);
    });
</script>
<script>
    jQuery(document).ready(function() {

        //FormValidator.init();

        $("#binding_form").validate({
            rules: {
                binding_mobile: {
                    required:true,
                    number:true,
                    minlength:11,
                    remote: {
                        url: "{:U('Wap/Login/cheack_binding_mobile')}",
                        type: "get",
                        dataType: "json",
                        data: {
                            mobile: function () {
                                return $("#binding_mobile").val();　　　　//这个是取要验证的数据
                            }
                        },
                        dataFilter: function (msg) {　　　　//判断控制器返回的内容
                            $('#is_binding').val(msg);
                            //0  未注册 1 已注册
                            if(msg=='0'){//填写密码
                                $('.binding_set_pwd').show();
                            }else{
                                $('.binding_set_pwd').hide();
                            }
                            return true;
                        }
                    }
                },
                binding_mobile_code: {
                    required:true,
                    remote: {
                        url: "{:U('Wap/Login/check_send_reg')}",
                        type: "get",
                        dataType: "json",
                        data: {
                            mobile: function () {
                                return $("#binding_mobile").val();　　　　//这个是取要验证的数据
                            },
                            mobile_code: function () {
                                return $("#binding_mobile_code").val();　　　　//这个是取要验证的数据
                            }
                        },
                        dataFilter: function (msg) {　　　　//判断控制器返回的内容
                            if (msg == "1") {
                                return true;
                            }else {
                                return false;
                            }
                        }
                    }
                },

            },
            messages: {
                binding_mobile:{
                    binding_pwd_required:'<span class="icon-warning icon_warning"></span>&nbsp;请输入手机号码',
                    number:'<span class="icon-warning icon_warning"></span>&nbsp;请输入正确的手机号码',
                    minlength:'<span class="icon-warning icon_warning"></span>&nbsp;请输入正确的手机号码',
                    remote:'<span class="icon-warning icon_warning"></span>&nbsp;手机号码已注册'
                },
                binding_mobile_code: {
                    required:'<span class="icon-warning icon_warning"></span>&nbsp;请输入手机验证码',
                    remote:'<span class="icon-warning icon_warning"></span>&nbsp;手机验证码不正确'
                }
            },
            focusInvalid:false,
            success: function(label) {
                // set  as text for IE 
                // alert('ok'); 
                //label.html(" ").addClass("checked"); 
            },
            /*执行ajaxsubmit  */
            submitHandler: function(editform) {

                var options = {
                    url :  "<?php echo U('Wap/Login/binding'); ?>",
                    type : "post" ,
                    dataType:'json',
                    target : "#loader",
                    error: function(){layer.msg("服务器没有返回数据，可能服务器忙，请重试",{icon:5});},
                    onwait : "正在处理信息，请稍候...",
                    success: function(response){
                        // console.log(response);
                        //$("#loader").fadeIn(500).html(response.data).fadeOut(500); 
                        //$('#editform').hide(2000); 
                        if(response.status==1){
                            //alert("注册成功");
                            layer.msg('绑定成功', {icon: 6},function(){
                                //关闭后的操作
                                window.location.href="<?php echo U('Wap/Member/index'); ?>";
                            });
                        }else{
                            layer.msg(response.error, {icon: 5});
                            // alert(response.error);
                        }
                    }
                };
                setTimeout((function(opt){
                    return function(){
                        $('#binding_form').ajaxSubmit(opt);
                    }
                })(options), 300);
                return false;
            }

        });



        $('.phone_binding_btn').click(function(){
            $('#binding_form').submit();
        });

        $('.binding_send_sms').click(function(){
            var is_send=$(this).hasClass('disable');
            if(is_send){
                return false;
            }else{
                //短信发送
                $.ajax({
                    url: "{:U('Wap/Login/binding_send_sms')}",
                    type: "get",
                    dataType: "json",
                    data: {
                        mobile: function () {
                            return $("#binding_mobile").val();　　　　//这个是取要验证的数据
                        }
                    },
                    success: function (msg) {　　　　//判断控制器返回的内容
                        if (msg.status == "1") {
                            //disable
                            // $('#mobile_code').val(msg.code);
                            // alert("验证码发送成功");
                            layer.msg('验证码发送成功', {icon: 6});
                            run_time_out();
                        }else {
                            // alert(msg.msg);
                            layer.msg(msg.msg, {icon: 5});
                        }
                    }
                });
            }
        });

    });
    function run_time_out(){
        var num=$('.binding_num').html();
        num=parseInt(num);
        var is_send=$('.binding_send_sms').hasClass('disable');
        if(num>0){
            $('.binding_get_sms').hide();
            $('.binding_countdown').show();
            $('.binding_send_sms').css('cssText','background-color: #eee;color: #666;-webkit-appearance: none;');
            num--;
            $('.binding_num').html(num);//显示倒计时
            if(!is_send){
                $('.binding_send_sms').addClass('disable');///禁止点击
            }
        }else{
            $('.binding_countdown').hide();
            $('.binding_get_sms').show();
            $('.binding_num').html(60);//初始化倒计时
            $('.binding_send_sms').removeClass('disable');///可以点击
            $('.binding_send_sms').removeAttr('style');
            return false;
        }
        setTimeout('run_time_out()',1000);
    }
</script>
</if>
<script type="text/javascript">
    $(function(){
        $('.binding_phone_close').click(function(){
            $('.binding_phone_head_all').hide();
        });

        $('.binding_phone_go').click(function(){
            get_binding()
        });

        $('.is_guanzhu_close').click(function(){
            $('.is_guanzhu_all').remove();
        });
        set_scroll()

    });
    $(window).scroll(function () {
        set_scroll()
    });
    function set_scroll(){
        if ($(window).scrollTop() > 5) {
            $(".is_guanzhu_all").css('cssText', 'position:fixed;top:0;z-index:999;');
            ;
        }
        else {
            $(".is_guanzhu_all").css('cssText', '');
            ;
        }
    }
</script>